PRD v0.4
Project Architecture Mapper
Architecture Context Artifact for Humans & LLMs

Статус: Final Planning / Ready for Implementation
Версия: 0.4
Фокус версии: архитектурные инварианты, детерминизм, контроль шума, масштабирование

0. Executive Summary

Project Architecture Mapper — это инструмент, генерирующий Architecture Context Artifact (ARCHITECTURE.md) — компактную, детерминированную и LLM-friendly карту кодовой базы.

Цель инструмента — дать человеку и AI-агенту целостную картину архитектуры до чтения исходников, чтобы:

снизить токен-стоимость,

ускорить понимание легаси,

повысить качество планирования рефакторинга,

избежать опасных изменений (циклы, нарушения границ).

Инструмент не является линтером или enforcement-системой. Он работает на эвристиках и управляет вниманием, а не выносит приговоры.

1. Problem Statement
Контекст

Современные AI-агенты способны эффективно рефакторить код, если у них есть архитектурный контекст. В реальных проектах этот контекст:

распределён по сотням/тысячам файлов,

не помещается в контекст LLM,

требует ручного объяснения.

Основные проблемы

LLM вынужден читать слишком много файлов → дорого и медленно

Существующие инструменты дают:

огромные JSON

графы-картинки (непригодны для LLM)

Разработчик не видит быстро:

где циклы,

где нарушения границ,

где настоящие hotspots,

где можно безопасно начинать рефакторинг

Ручные описания архитектуры:

субъективны

неполны

невоспроизводимы

2. What This Tool Is / Is Not
This tool IS

Генератор Architecture Context Artifact

Инструмент навигации и приоритизации

Подготовительный слой для человека и LLM

Эвристический анализ структуры и импортов

Основа для diff-first архитектурного анализа

This tool IS NOT

❌ Линтер или архитектурный “enforcer”

❌ CI-gate по умолчанию

❌ Автоматический рефакторинг

❌ Семантический анализ бизнес-логики

❌ Data-flow анализ

❌ Истина в последней инстанции

Философия:

Инструмент помогает думать, а не решает.

3. Core Concept: Architecture Context Artifact

Architecture Context Artifact — это единый файл ARCHITECTURE.md, который:

читается целиком (человеком и LLM),

используется до чтения исходников,

даёт карту местности для планирования,

оптимизирован под токены и внимание.

Ключевой принцип

LLM сначала получает карту, затем точечно читает файлы.

4. Deterministic Output Guarantee (Инвариант v0.4)
Проблема

Diff-first сценарии невозможны без строгого детерминизма.

Требование (ЖЁСТКОЕ)

При неизменной кодовой базе инструмент обязан генерировать бит-в-бит идентичный ARCHITECTURE.md.

Обязательные условия

Сортировка директорий — строго по алфавиту

Сортировка файлов — строго по алфавиту

Сортировка импортов внутри файла — строго по алфавиту

Стабильный порядок вывода сигналов

Отсутствие nondeterministic traversal (fs.readdir, async race и т.п.)

Любое изменение в файле карты = реальное архитектурное изменение.

5. Global Analysis, Local Rendering (Инвариант v0.4)
Проблема

Focus Mode может скрыть критические проблемы (например, глобальные циклы).

Архитектурное требование

Алгоритм строго разделён на два этапа:

5.1 Global Analysis Phase

анализ всего проекта

построение полного графа зависимостей

детекция всех сигналов и циклов

5.2 Rendering Phase

применение --focus, --depth, collapse

скрытие нерелевантных частей только визуально

Гарантия

Focus Mode никогда не может скрыть структурную проблему, влияющую на видимую область.

Если скрытый модуль участвует в сигнале:

он обязан быть упомянут как stub.

6. Output Format
Формат

Markdown

Дерево директорий (├──, └──)

Краткие сигналы и зависимости

Пример
/src
  /features/auth
    ├── index.ts
    │   (! CYCLE: ./model/store.ts -> ../user/model.ts -> ./index.ts)
    └── model/auth.store.ts
        (450 loc) (? BIG) (? GOD-MODULE) (i HIGH-CHURN 50/m)
        -> (@/shared/api, @/entities/user, ...)

Принципы компактности

только локальные импорты

top-N импортов (по умолчанию 5)

остальное — ...

7. Signals Model

Сигналы — подсказки, а не ошибки.

7.1 Structural Risks (!)

CYCLE — циклические зависимости
Формат обязателен:
(! CYCLE: A.ts -> B.ts -> C.ts -> A.ts)

LAYER-BREACH — нарушения профиля слоёв

7.2 Heuristic Hints (? )

BIG — файл > N строк

GOD-MODULE — входящих зависимостей > M

DEEP-PATH — ../../../ глубже порога

BARREL-HELL — index.ts с большим числом экспортов

7.3 Context Signals (i)

HIGH-CHURN — часто меняется

STALE — давно не менялся

ORPHAN — нет входящих импортов (с осторожностью)

8. Signal Budgeting & Noise Control (v0.4)
Проблема

В легаси-проектах сигналы могут перегрузить внимание.

Решение

Каждый тип сигнала имеет лимит отображения.

Пример
(! CYCLE) Found 147 cycles (showing top 5 shortest)
(? BIG)   Found 82 files (showing top 20 by LOC)


Принцип:

Мы не скрываем правду, мы управляем вниманием.

9. Smart Collapse (Принцип v0.4)

Show problems, hide boring structure

Правила

папка может быть схлопнута, если:

внутри нет (!) или (? )

если в глубине есть (!):

путь к нему раскрывается автоматически

--depth — мягкое ограничение

10. Architecture Profiles
10.1 Default (structure-agnostic)

CYCLE, BIG, GOD-MODULE, DEEP-PATH

HIGH-CHURN, STALE, ORPHAN

10.2 FSD Profile (opt-in)

LAYER-BREACH

FEATURE-CROSS

FSD — профиль, а не норма.

11. Alias Resolution (Baseline Requirement)
Проблема

Без алиасов граф разрывается.

Требование

Эвристический резолвинг:

@/* → ./src/*

~/ → ./src/

src/* → ./src/*

Цель — связность графа, не 100% точность.

12. Parsing Strategy
MVP

улучшенный Regex

multi-line imports

re-exports

dynamic imports (best effort)

Опционально

TypeScript Compiler API, если typescript уже установлен

13. Diff-first Use Cases

сравнение до/после рефакторинга

архитектурный review PR

обнаружение регрессий (новые циклы, breaches)

14. AI Preamble (Optional)

Опциональный блок инструкций для LLM:

как использовать карту

в каком порядке реагировать на сигналы

Не контракт, не обязателен, полностью заменяем.

15. Non-Goals

❌ семантический анализ

❌ data-flow анализ

❌ enforcement архитектуры

❌ идеальная точность

❌ замена линтеров и тестов

16. Итог

PRD v0.4 фиксирует:

детерминизм,

глобальную корректность,

управляемый шум,

масштабируемость,

LLM-first мышление